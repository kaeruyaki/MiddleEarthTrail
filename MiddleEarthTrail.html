<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Middle Earth Trail</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #18181b; /* Zinc 900 */
            color: #d4d4d8; /* Zinc 300 */
        }
        .font-title {
            font-family: 'IM Fell English SC', serif;
        }
        /* Custom scrollbar for a more thematic feel */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #27272a; /* Zinc 800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #52525b; /* Zinc 600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #71717a; /* Zinc 500 */
        }
        /* Styling for disabled buttons */
        .game-button:disabled {
            background-color: #3f3f46; /* Zinc 700 */
            color: #a1a1aa; /* Zinc 400 */
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .map-landmark-label {
             font-size: 14px;
             fill: #fde68a; /* Amber 200 */
             text-anchor: middle;
             pointer-events: none;
             font-weight: 600;
             paint-order: stroke;
             stroke: #18181b; /* Zinc 900 */
             stroke-width: 2px;
             stroke-linecap: butt;
             stroke-linejoin: miter;
        }
        .map-feature {
            fill: none;
            stroke: #52525b; /* Zinc 600 */
            stroke-width: 1.5;
            stroke-linecap: round;
            stroke-linejoin: round;
            opacity: 0.5;
        }
    </style>
</head>
<body class="bg-zinc-900 text-stone-300">

    <!-- Start Screen -->
    <div id="start-screen" class="fixed inset-0 bg-zinc-900/95 flex flex-col items-center justify-center z-50 p-4">
        <h1 class="font-title text-5xl md:text-6xl text-amber-200 mb-4 text-center" style="text-shadow: 0 0 15px rgba(252, 211, 77, 0.4);">The Middle Earth Trail</h1>
        <p class="text-lg text-stone-400 max-w-2xl text-center mb-8">The fate of Middle-earth rests on your shoulders. Before you set out from the Shire, you must choose your family's background. This choice determines your starting resources.</p>
        <div class="flex flex-wrap justify-center gap-4 mb-8">
            <div class="profession-card cursor-pointer bg-black/20 border-2 border-white/10 rounded-lg p-6 w-52 text-center transition-all duration-300 hover:border-amber-400/50 hover:scale-105" data-profession="Baggins">
                <h3 class="font-title text-2xl text-emerald-300 mb-2">Baggins</h3>
                <p class="text-stone-400">More Gold & Food</p>
            </div>
            <div class="profession-card cursor-pointer bg-black/20 border-2 border-white/10 rounded-lg p-6 w-52 text-center transition-all duration-300 hover:border-amber-400/50 hover:scale-105" data-profession="Took">
                <h3 class="font-title text-2xl text-emerald-300 mb-2">Took</h3>
                <p class="text-stone-400">More Supplies</p>
            </div>
            <div class="profession-card cursor-pointer bg-black/20 border-2 border-white/10 rounded-lg p-6 w-52 text-center transition-all duration-300 hover:border-amber-400/50 hover:scale-105" data-profession="Brandybuck">
                <h3 class="font-title text-2xl text-emerald-300 mb-2">Brandybuck</h3>
                <p class="text-stone-400">All-arounder</p>
            </div>
        </div>
        <div class="mb-4">
            <label for="debug-start-select" class="mr-2 text-stone-400">Debug Start:</label>
            <select id="debug-start-select" class="bg-zinc-800 border border-zinc-700 rounded-md px-3 py-1"></select>
        </div>
        <div class="flex flex-col sm:flex-row gap-4 mb-8 text-stone-300">
            <div>
                <input type="checkbox" id="debug-quick-travel">
                <label for="debug-quick-travel">Quick Travel (1 Day/Leg)</label>
            </div>
            <div>
                <input type="checkbox" id="debug-story-only">
                <label for="debug-story-only">Story Mode Only (No Random Encounters)</label>
            </div>
        </div>
        <button id="begin-journey-button" class="font-title text-2xl bg-amber-700 hover:bg-amber-600 text-amber-50 font-bold py-3 px-12 rounded-lg shadow-lg transition-transform hover:scale-105 disabled:bg-zinc-700 disabled:text-zinc-500 disabled:cursor-not-allowed" disabled>Begin Journey</button>
    </div>

    <!-- Main Game Container -->
    <div id="game-container" class="hidden w-full max-w-7xl mx-auto p-4 lg:p-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-6">
            
            <!-- Left/Main Column -->
            <div class="lg:col-span-2 bg-black/20 rounded-xl shadow-lg border border-white/10 p-4 sm:p-6 flex flex-col">
                <div id="main-view" class="flex-grow flex flex-col">
                    <!-- Views will be dynamically inserted here -->
                </div>
            </div>

            <!-- Right/Status Column -->
            <div class="flex flex-col gap-4 lg:gap-6">
                <!-- Party Status -->
                <div class="bg-black/20 rounded-xl shadow-lg border border-white/10 p-4 sm:p-6">
                    <h2 class="font-title text-2xl text-emerald-300 border-b border-white/10 pb-2 mb-4">Journey Status</h2>
                    <div id="party-status-display" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-2 gap-4 text-sm">
                        <!-- Party status items will be injected here -->
                    </div>
                </div>
                <!-- Fellowship Status -->
                <div class="bg-black/20 rounded-xl shadow-lg border border-white/10 p-4 sm:p-6">
                    <h2 class="font-title text-2xl text-emerald-300 border-b border-white/10 pb-2 mb-4">Fellowship</h2>
                    <div id="fellowship-display" class="space-y-3">
                        <!-- Fellowship members will be injected here -->
                    </div>
                </div>
            </div>

        </div>
    </div>

<script type="module">
// --- ICONS ---
const ICONS = {
    day: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline-block text-amber-300" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 7.072l.707-.707a1 1 0 10-1.414-1.414l-.707.707a1 1 0 001.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z" clip-rule="evenodd" /></svg>`,
    location: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline-block text-sky-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>`,
    distance: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline-block text-stone-400" viewBox="0 0 20 20" fill="currentColor"><path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" /><path fill-rule="evenodd" d="M12 1.5a.5.5 0 01.5.5v4.813l1.32-1.32a.5.5 0 11.708.708l-2.061 2.06a.5.5 0 01-.707 0L9.46 6.2a.5.5 0 11.707-.708l1.332 1.332V2a.5.5 0 01.5-.5zm-4-1a.5.5 0 01.5.5v5.06l1.32-1.32a.5.5 0 11.708.708l-2.061 2.06a.5.5 0 01-.707 0L5.46 5.7a.5.5 0 11.707-.708L7.5 6.26V1a.5.5 0 01.5-.5z" clip-rule="evenodd" /></svg>`,
    food: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline-block text-lime-400" viewBox="0 0 20 20" fill="currentColor"><path d="M10.394 2.08a1 1 0 00-.788 0l-7 3.5a1 1 0 000 1.84L9 9.61v5.08a1 1 0 00.528.885l3.5 2a1 1 0 001.472-.885v-5.08l6.606-3.302a1 1 0 000-1.84l-7-3.5z" /></svg>`,
    supplies: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline-block text-orange-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 3a1 1 0 011-1h.01a1 1 0 010 2H7a1 1 0 01-1-1zm2 0a1 1 0 011-1h3a1 1 0 110 2h-3a1 1 0 01-1-1zm-4 8a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm2 0a1 1 0 011-1h1a1 1 0 110 2H9a1 1 0 01-1-1zm4-4a1 1 0 100-2h-1a1 1 0 100 2h1zM5 7a1 1 0 011-1h1a1 1 0 110 2H6a1 1 0 01-1-1zm2 0a1 1 0 011-1h1a1 1 0 110 2H9a1 1 0 01-1-1zm4-1a1 1 0 10-2 0v1a1 1 0 102 0V6zM5 15a1 1 0 011-1h1a1 1 0 110 2H6a1 1 0 01-1-1zm2 0a1 1 0 011-1h1a1 1 0 110 2H9a1 1 0 01-1-1zm4 0a1 1 0 011-1h1a1 1 0 110 2h-1a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>`,
    morale: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline-block text-rose-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg>`,
    gold: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline-block text-yellow-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`
};

// --- GAME CONSTANTS ---
const HOURS_PER_SECOND = 2; 
const HOURLY_FOOD_CONSUMPTION = 0.25;
const HOURLY_DISTANCE_TRAVEL = 1;
const DAILY_HEALTH_LOSS = 3;

// --- GAME STATE ---
let gameState = {};
let gameLoopInterval = null;
let animationFrame = 0;

// --- UI ELEMENTS ---
const startScreen = document.getElementById('start-screen');
const gameContainer = document.getElementById('game-container');
const mainView = document.getElementById('main-view');
const partyStatusDisplay = document.getElementById('party-status-display');
const fellowshipDisplay = document.getElementById('fellowship-display');

// --- GAME DATA ---
const professions = {
    Baggins:   { food: 100, supplies: 50, gold: 100 },
    Took:      { food: 50, supplies: 150, gold: 50 },
    Brandybuck:{ food: 85, supplies: 85, gold: 80 }
};

const journeyData = {
    'shire': { name: "The Shire", x: 180, y: 350, distance: 0, legName: "The Road to Bree", next: 'bree', locationType: 'wild' },
    'bree': { name: "Bree", x: 280, y: 360, distance: 100, legName: "To Weathertop", next: 'weathertop', type: 'town', description: "You arrive in the bustling town of Bree and find lodging at the Prancing Pony. The common room is filled with folk of all sorts, and a mysterious, hooded man watches you from a dark corner.", locationType: 'town' },
    'weathertop': { name: "Weathertop", x: 320, y: 358, distance: 150, legName: "The Road to the Trollshaws", next: 'trollshaws', locationType: 'wild' },
    'trollshaws': { name: "Trollshaws", x: 350, y: 355, distance: 175, legName: "The Road to Rivendell", next: 'rivendell', locationType: 'wild' },
    'rivendell': { name: "Rivendell", x: 400, y: 350, distance: 250, next: 'caradhras_pass', type: 'town', description: "You have come to the Last Homely House East of the Sea. The air is filled with peace and ancient wisdom. Elrond greets you, his eyes holding the light of stars.", locationType: 'town' },
    'caradhras_pass': { name: "Pass of Caradhras", x: 450, y: 400, distance: 300, legName: "Over the Misty Mountains", next: 'lothlorien', locationType: 'wild' },
    'moria': { name: "Mines of Moria", x: 460, y: 450, distance: 350, legName: "Through Khazad-dûm", next: 'lothlorien', locationType: 'wild' },
    'lothlorien': { name: "Lothlórien", x: 520, y: 480, distance: 550, legName: "The Great River", next: 'anduin', locationType: 'wild' },
    'anduin': { name: "Anduin River", x: 550, y: 550, distance: 650, legName: "The Breaking of the Fellowship", next: 'amonhen', locationType: 'wild' },
    'amonhen': { name: "Amon Hen", x: 560, y: 600, distance: 700, legName: "The Emyn Muil", next: 'emynmuil', locationType: 'wild' },
    'emynmuil': { name: "Emyn Muil", x: 600, y: 620, distance: 750, legName: "The Dead Marshes", next: 'deadmarshes', locationType: 'wild' },
    'deadmarshes': { name: "Dead Marshes", x: 680, y: 610, distance: 800, legName: "To the Black Gate", next: 'blackgate', locationType: 'wild' },
    'blackgate': { name: "The Black Gate", x: 750, y: 600, distance: 900, next: null, locationType: 'wild' },
    'cirithungol': { name: "Cirith Ungol", x: 780, y: 650, distance: 950, legName: "The Land of Shadow", next: 'mountdoom', locationType: 'wild' },
    'mountdoom': { name: "Mount Doom", x: 850, y: 630, distance: 1000, type: 'end', locationType: 'wild' }
};

const townActions = {
    'bree': [
        { id: 'bree_gossip', text: "Listen for Rumors", action: (dialogueEl) => { advanceTime(1); dialogueEl.innerHTML = `You spend some time listening to chatter and hear tales of black riders on the road and troubles from the south. The mood is grim.`; } },
        { id: 'bree_trade', text: "Trade for Supplies", condition: () => gameState.gold >= 15, action: (dialogueEl) => { advanceTime(1); gameState.gold -= 15; gameState.supplies += 25; dialogueEl.innerHTML = `The trade takes a short while. You get 25 supplies for 15 gold.`; } },
        { id: 'bree_meet_strider', text: "Speak to the hooded man", oneTime: true, action: (dialogueEl) => { advanceTime(0.5); meetStrider(); dialogueEl.innerHTML = `You speak briefly with the ranger. His name is Strider. He knows of your quest and offers to guide you.`; } },
        { id: 'bree_leave', text: "Leave Bree", isLeaveAction: true, action: () => { if (!gameState.fellowship.some(m => m.name === 'Strider')) { meetStrider(); } gameState.currentLocationKey = 'weathertop'; gameState.pathTaken.push('weathertop'); showTravelView(); } }
    ],
    'rivendell': [
        { id: 'rivendell_rest', text: "Rest", action: (dialogueEl) => { advanceTime(8); gameState.fellowship.forEach(m => m.health = Math.min(100, m.health + 25)); gameState.morale = 100; dialogueEl.innerHTML = `You rest deeply through the night and into the next day in the Last Homely House. Your health and spirits are fully restored.`; } },
        { id: 'rivendell_council', text: "Attend the Council of Elrond", oneTime: true, action: (dialogueEl) => { advanceTime(4); storyTriggers.rivendell(gameState); dialogueEl.innerHTML = `The council lasts for many hours. Elrond declares that the Ring must be destroyed in the fires of Mount Doom. The Fellowship of the Ring is formed to aid the Ringbearer! Legolas, Gimli, Boromir, and Gandalf join your cause.`; } },
        { id: 'rivendell_leave', text: "Leave Rivendell", isLeaveAction: true, condition: () => gameState.flags.councilOfElrondComplete, action: () => { gameState.currentLocationKey = 'caradhras_pass'; gameState.pathTaken.push('caradhras_pass'); showTravelView(); } }
    ]
};

const encounters = {
    // --- STORY ENCOUNTERS ---
    'weathertop': {
        name: "The Witch-king at Weathertop",
        description: "At the summit of the ancient watchtower, you see them—five black figures against the skyline. The Nazgûl. Their leader draws a long sword that glitters with a cold, pale light. A cry of pure terror and hatred splits the air as they advance, and Frodo feels an overwhelming urge to put on the Ring.",
        type: 'story',
        trigger: 'landmark_arrival',
        choices: [
            { text: "Frodo resists the urge", action: () => { const healthLost = Math.floor(Math.random() * 20) + 15; gameState.fellowship.find(m => m.name === 'Frodo').health -= healthLost; gameState.morale -= 30; return `Aragorn leaps to defend the hobbits, brandishing fire against the Wraiths. They are driven back, but not before Frodo is gravely wounded by a Morgul-blade! You must get him to Rivendell!`; } },
            { text: "Frodo puts on the Ring", action: () => { gameState.fellowship.find(m => m.name === 'Frodo').health -= 40; gameState.morale -= 40; return `Frodo vanishes, entering the wraith-world. The Witch-king strikes with a Morgul-blade, and a shard of ice enters Frodo's shoulder. He is fading fast! You must race to Rivendell!`; } }
        ]
    },
    'caradhras_pass': {
        name: "The Pass of Caradhras",
        description: "As you climb higher into the mountains, the air grows thin and a cruel wind howls. A sudden, unnatural snowstorm descends, blinding you with swirling white. The voice of Saruman echoes in the storm, a fell magic seeking to crush you.",
        type: 'story',
        trigger: 'landmark_arrival',
        choices: [
            { text: "Attempt to push through the snow", action: () => {
                gameState.fellowship.forEach(m => m.health -= 25);
                gameState.morale -= 30;
                if (Math.random() < 0.2) { // 20% chance to succeed
                    gameState.currentLocationKey = 'lothlorien';
                    gameState.pathTaken.push('lothlorien');
                    return `Against all odds, you endure the storm's wrath! The pass is behind you, and the golden wood of Lothlórien lies ahead. The ordeal has left you battered but resolute.`;
                } else {
                    gameState.currentLocationKey = 'moria';
                    gameState.pathTaken.pop();
                    gameState.pathTaken.push('moria');
                    return `You fight against the blizzard for hours, but the cruel magic of the mountain is too strong. Beaten and frostbitten, you are forced to turn back. There is another way... through the darkness of Moria.`;
                }
            }},
            { text: "Turn back and take the path through Moria", action: () => {
                gameState.currentLocationKey = 'moria';
                gameState.pathTaken.pop(); // Remove caradhras_pass
                gameState.pathTaken.push('moria');
                // This will show the result, and then the next game loop will handle arriving at Moria.
                return `The mountain has defeated you. With heavy hearts, you turn back and take the dark and secret way through the Mines of Moria.`;
            }}
        ]
    },
    'moria': {
        name: "The Bridge of Khazad-dûm",
        description: "You have fled through the endless dark of Moria, but at the bridge, a shadow rises from the depths. A Balrog of Morgoth, a demon of the ancient world, blocks your path. Gandalf turns to face it. 'You cannot pass!' he cries.",
        type: 'story',
        trigger: 'landmark_arrival',
        choices: [
            { text: "Fly, you fools!", action: () => { 
                storyTriggers.moria(gameState);
                gameState.currentLocationKey = 'lothlorien';
                gameState.pathTaken.push('lothlorien');
                return `Gandalf confronts the Balrog, and both fall into the abyss. The Fellowship escapes, but their guide and friend is lost. Grief-stricken, you make your way to the woods of Lothlórien.`;
            }}
        ]
    },
    'amonhen': {
        name: "The Breaking of the Fellowship",
        description: "At Amon Hen, Boromir tries to take the Ring. In the chaos, he is slain by Uruk-hai. Frodo, realizing the Ring's corrupting influence, decides he must go on alone... but Samwise refuses to leave his side. The Fellowship is broken.",
        type: 'story',
        trigger: 'landmark_arrival',
        choices: [
            { text: "Face the inevitable", action: () => { 
                storyTriggers.amonhen(gameState);
                gameState.currentLocationKey = 'emynmuil';
                gameState.pathTaken.push('emynmuil');
                return "The Fellowship is broken. Only Frodo and Sam remain to continue the quest into the lands of Mordor.";
            }}
        ]
    },
    // --- RANDOM ENCOUNTERS ---
    'fruit-trees': {
        name: "Fruit Trees", description: "You come upon a small, sun-dappled orchard of wild apple trees, their branches heavy with ripe fruit.", type: 'friendly', trigger: 'travel', weight: 8,
        choices: [
            { text: "Eat your fill", action: () => { advanceTime(1); gameState.fellowship.forEach(m => m.health = Math.min(100, m.health + 5)); gameState.morale = Math.min(100, gameState.morale + 5); return `You stop for a while to eat. The fresh fruit is delicious and revitalizing.`; } },
            { text: "Gather for the road", action: () => { advanceTime(2); const foodFound = Math.floor(Math.random() * 15) + 10; gameState.food += foodFound; return `It takes some time, but you gather the best fruit, adding <span class="text-positive">${foodFound} food</span> to your stores.`; } },
            { text: "Do nothing", action: () => `You press on, leaving the bounty behind.` }
        ]
    },
    'orc-patrol': {
        name: "Orc Patrol", description: "A harsh guttural speech echoes from ahead. A patrol of Orcs, their scimitars cruelly sharp, march down the path. They have not yet seen you.", type: 'hostile', trigger: 'travel', weight: 7,
        choices: [
            { text: "Set an ambush", action: () => { advanceTime(1); if (Math.random() < 0.75) { const s = Math.floor(Math.random() * 10); gameState.supplies += s; gameState.morale += 5; return `<span class="text-positive">The ambush is perfect!</span> You dispatch the Orcs swiftly, finding ${s} supplies.`; } else { gameState.fellowship.forEach(m => { if(m.health > 0) m.health -= (Math.random() * 15) }); gameState.morale -= 10; return `<span class="text-negative">They spot you too soon!</span> A fierce skirmish ensues.`; } } },
            { text: "Attempt to sneak past", action: () => { advanceTime(2); if (Math.random() < 0.5) { return `<span class="text-positive">It takes a couple of tense hours, but you slip by unnoticed.</span>`; } else { const s = Math.floor(Math.random() * 10) + 5; gameState.supplies = Math.max(0, gameState.supplies - s); gameState.morale -= 10; return `<span class="text-negative">Spotted!</span> You drop ${s} supplies to create a diversion and escape.`; } } },
            { text: "Confront them head-on", action: () => { advanceTime(1); let txt = ""; gameState.fellowship.forEach(m => { if(m.health > 0) m.health -= (Math.random() * 25) }); gameState.morale -= 15; const c = performDeathRolls("battle"); if(c) { txt = `<span class="text-catastrophic">The battle is brutal.</span> ${c}`; } else { txt = `<span class="text-negative">The battle is brutal, leaving everyone wounded.</span>`; } return txt; } }
        ]
    },
    'lost-in-wild': {
        name: "Lost in the Wild", description: "The landscape has become a monotonous, rolling terrain. The path is gone. You are lost.", type: "neutral", trigger: "travel", weight: 10,
        choices: [
            { text: "Trust the Ranger", condition: () => gameState.fellowship.some(m => m.name === 'Aragorn' && m.health > 0), action: () => { advanceTime(3); return `<span class="text-positive">Aragorn's skill guides you true after a few hours of searching.</span> You find the main path again.`; } },
            { text: "Climb for a view", action: () => { advanceTime(2); if (Math.random() < 0.6) { return `<span class="text-positive">After a short climb, you spot the correct path from a high vantage.</span>`; } else { const m = gameState.fellowship.find(m => m.health > 0); m.health -= 10; return `<span class="text-negative">${m.name} slips and falls while climbing.</span> The path remains hidden.`; } } },
            { text: "Press on blindly", action: () => { advanceTime(4); gameState.morale -= 10; return `<span class="text-neutral">You wander for hours, your spirits sinking, before finally stumbling back onto the path.</span>`; } }
        ]
    },
    'mountain-spring': {
        name: "Mountain Spring", description: "Tucked into a mossy rock face, you find a spring of crystal-clear water bubbling forth.", type: 'friendly', trigger: 'travel', weight: 8,
        choices: [
            { text: "Drink deeply", action: () => { advanceTime(1); gameState.fellowship.forEach(m => m.health = Math.min(100, m.health + 10)); gameState.morale += 10; return `You rest for a while. The pure, cold water is incredibly refreshing.`; } },
            { text: "Refill waterskins", action: () => { advanceTime(0.5); gameState.buffs.sustainingWater = (gameState.buffs.sustainingWater || gameState.totalHours) + 24; return `You quickly fill your waterskins. The water will sustain you for the next day.`; } },
            { text: "Do nothing", action: () => `You ignore the spring.` }
        ]
    },
    'sudden-downpour': {
        name: "Sudden Downpour", description: "The sky opens up without warning, and a cold, driving rain begins to fall.", type: 'neutral', trigger: 'travel', weight: 10,
        choices: [
            { text: "Push on", action: () => { advanceTime(1); gameState.fellowship.forEach(m => { if(m.health > 0) m.health -= 5 }); gameState.morale -= 5; return `You trudge on through the miserable rain, losing some health and morale.`; } },
            { text: "Find shelter", action: () => { advanceTime(2); return `You find a small overhang and wait for the worst of the storm to pass. It takes a couple of hours.`; } },
            { text: "Use supplies to make shelter", condition: () => gameState.supplies >= 5, action: () => { advanceTime(0.5); gameState.supplies -= 5; return `You quickly use 5 supplies to create a makeshift shelter.`; } }
        ]
    },
    'wargs-wild': {
        name: "Wargs of the Wild", description: "A howl echoes through the hills. A pack of Wargs, monstrous wolves with a malevolent gleam in their eyes, has caught your scent.", type: 'hostile', trigger: 'travel', weight: 4,
        choices: [
            { text: "Light fires to keep them at bay", condition: () => gameState.supplies >= 10, action: () => { advanceTime(1); gameState.supplies -= 10; gameState.morale -= 5; return `You quickly use 10 supplies to build protective fires. The Wargs snarl from the darkness for an hour but dare not approach.`; } },
            { text: "Stand and fight", action: () => { advanceTime(1); let txt = ""; gameState.fellowship.forEach(m => { if(m.health > 0) m.health -= (Math.random() * 20 + 10) }); gameState.morale -= 20; const c = performDeathRolls("the Warg attack"); if(c) { txt = `<span class="text-catastrophic">The Wargs are terrifyingly fast and strong!</span> ${c}`; } else { txt = `<span class="text-negative">You fight off the beasts, but not without suffering grievous wounds.</span>`; } return txt; } },
            { text: "Climb trees or rocks", action: () => { advanceTime(3); gameState.morale -= 10; return `You scramble up high ground, out of reach. You are trapped for hours until the pack moves on.`; } }
        ]
    },
    'athelas': {
        name: "Athelas (Kingsfoil)", description: "Aragorn kneels, his keen eyes spotting a patch of a seemingly plain weed. 'This is Athelas,' he murmurs. 'Kingsfoil.'", type: 'friendly', trigger: 'travel', weight: 2,
        condition: () => gameState.fellowship.some(m => m.name === 'Aragorn' && m.health > 0),
        choices: [
            { text: "Gather it", action: () => { advanceTime(1); gameState.inventory.athelas = (gameState.inventory.athelas || 0) + 1; return `You spend some time carefully gathering the precious herb, adding one use of Athelas to your inventory.`; } },
            { text: "Move on", action: () => `You leave the precious herb behind.` }
        ]
    },
    'abandoned-camp': {
        name: "An Abandoned Camp", description: "Through the trees, you see the faint grey smoke of a dying campfire. You approach cautiously to find a recently abandoned camp.", type: 'neutral', trigger: 'travel', weight: 7,
        choices: [
            { text: "Search it", action: () => { advanceTime(1); const r = Math.random(); if (r < 0.6) { const f = Math.floor(Math.random() * 10) + 5; gameState.food += f; return `Your search turns up ${f} leftover food rations. A lucky find!`; } else if (r < 0.8) { return `The camp is empty.`; } else { gameState.morale -= 10; return `It's a trap! A small band of goblins leap out. You fight them off but the encounter leaves you shaken.`; } } },
            { text: "Ignore it", action: () => `It's too risky. You leave the camp untouched and move on.` }
        ]
    },
    'eagles-gaze': {
        name: "The Eagles' Gaze", description: "High above, you spot the unmistakable silhouette of a Great Eagle. It circles once, a silent, powerful guardian, then soars away towards the east.", type: 'friendly', trigger: 'travel', weight: 2,
        choices: [
            { text: "Take heart", action: () => { gameState.morale = Math.min(100, gameState.morale + 15); return `The sight is a blessing. Morale is significantly boosted.`; } },
            { text: "Worry it is a spy", action: () => { gameState.morale -= 5; return `Could it be a spy for Saruman? The thought is unsettling.`; } }
        ]
    },
    'gollum-pursuit': {
        name: "Gollum's Pursuit", description: "In the quiet of the night, Sam hears it—a faint, wet, slapping sound from the rocks behind you, and a low, miserable whining. 'My preciousss...' Gollum is following you.", type: 'neutral', trigger: 'travel', weight: 1,
        condition: () => gameState.distanceTraveled > 400 && !gameState.flags.gollumFollowing,
        choices: [
            { text: "Try to lose him", action: () => { advanceTime(4); gameState.morale -= 5; return `You take a difficult, treacherous path for several hours to shake the creature.`; } },
            { text: "Confront him", action: () => { advanceTime(0.5); gameState.flags.gollumFollowing = true; return `You try to capture the creature, but he is too quick. You know he is still out there.`; } },
            { text: "Ignore him", action: () => { gameState.flags.gollumFollowing = true; return `You do nothing. The unsettling presence continues to follow you.`; } }
        ]
    },
    'nazgul-sighting': {
        name: "A Black Rider",
        description: "A chilling shriek pierces the air. A Black Rider is near!",
        type: 'hostile',
        trigger: 'travel',
        weight: 3,
        condition: () => gameState.distanceTraveled < journeyData.rivendell.distance,
        choices: function() {
            const locationType = journeyData[gameState.currentLocationKey].locationType;
            if (locationType === 'town') {
                return [
                    { text: "Barricade yourselves in the Inn", action: () => { advanceTime(3); gameState.morale -= 15; return `You spend a terrifying few hours barricaded inside as the Nazgûl searches the town. Eventually, it moves on.`; } },
                    { text: "Flee the town immediately", action: () => { advanceTime(1); gameState.morale -= 10; return `You gather your things in a panic and flee into the wilderness, not stopping until the sun rises.`; } },
                    { text: "Hide in the stables", action: () => { advanceTime(2); if (Math.random() < 0.3) { gameState.supplies = Math.max(0, gameState.supplies - 20); return `The Rider finds you! You create a diversion by releasing the horses and lose some supplies in the chaos.`; } else { return `You hide amongst the hay and animals. The Rider passes by, its presence chilling you to the bone.`; } } }
                ];
            } else { // wild
                return [
                    { text: "Run for a river crossing", action: () => { advanceTime(2); gameState.distanceTraveled += 5; return `You race for a nearby river, hoping the water will deter the wraith. The desperate flight takes its toll.`; } },
                    { text: "Hide in the grass", action: () => { advanceTime(3); if (Math.random() < 0.5) { gameState.morale -= 20; return `The Rider passes so close you can hear its fell whispers. The terror is immense, but you remain unseen.`; } else { return `You lie still for what feels like an eternity. The Rider eventually moves on.`; } } },
                    { text: "Ward with fire", condition: () => gameState.fellowship.some(m => m.name.includes('Aragorn')), action: () => { advanceTime(1); gameState.morale -= 5; return `Aragorn brandishes a torch, and the Rider recoils from the flame, giving you time to escape.`; } }
                ];
            }
        }
    }
};

// --- HELPER & UTILITY FUNCTIONS ---
const deathChecks = { 'Hobbit': 0.01, 'Man': 0.02, 'Dwarf': 0.02, 'Elf': 0.005, 'Wizard': 0.005 };

function performDeathRolls(encounterName = "battle") {
    let casualties = '';
    gameState.fellowship.forEach(member => {
        if (member.health > 0 && Math.random() < deathChecks[member.race]) {
            member.health = 0;
            casualties += `<br><strong class="text-red-500">${member.name} has fallen in ${encounterName}!</strong>`;
        }
    });
    if (casualties) {
        gameState.morale = Math.max(0, gameState.morale - 25);
    }
    return casualties;
}

function getHealthStatus(health) {
    const h = Math.max(0, health);
    if (h === 0) return { text: 'Dead', colorClass: 'text-red-500' };
    if (h <= 10) return { text: 'Very Poor', colorClass: 'text-red-400' };
    if (h <= 30) return { text: 'Poor', colorClass: 'text-orange-400' };
    if (h <= 50) return { text: 'Average', colorClass: 'text-yellow-400' };
    if (h <= 70) return { text: 'Fair', colorClass: 'text-lime-400' };
    if (h <= 90) return { text: 'Good', colorClass: 'text-green-400' };
    return { text: 'Great', colorClass: 'text-green-300' };
}

function getTimeOfDayString(hour) {
    const h = Math.floor(hour % 24);
    if (h >= 23 || h < 4) return 'Midnight';
    if (h < 6) return 'Before Dawn';
    if (h < 8) return 'Dawn';
    if (h < 12) return 'Morning';
    if (h < 14) return 'Noon';
    if (h < 17) return 'Afternoon';
    if (h < 19) return 'Late Afternoon';
    if (h < 21) return 'Evening';
    return 'Night';
}

function meetStrider() {
    if (!gameState.fellowship.some(m => m.name === 'Strider' || m.name === 'Aragorn')) {
        gameState.fellowship.push({ name: 'Strider', race: 'Man', health: 100 });
        displayEvent({
            name: "A Ranger in the Corner",
            description: "The mysterious ranger approaches your table. 'I am called Strider,' he says. 'I know of the burden you carry, and the road ahead is dangerous. You will need my help.' His eyes are keen and he seems trustworthy, despite his rough appearance.",
            choices: [
                { text: "Accept his offer", action: () => `Strider has joined your party. His knowledge of the wild will be invaluable.` }
            ]
        });
    }
}

// --- CORE GAME LOGIC ---
const storyTriggers = {
    'bree': (state) => {
        if (!state.fellowship.some(m => m.name === 'Strider' || m.name === 'Aragorn')) {
            state.fellowship.push({ name: 'Strider', race: 'Man', health: 100 });
        }
        state.completedTownActions.add('bree_meet_strider');
    },
    'rivendell': (state) => {
        const strider = state.fellowship.find(m => m.name === 'Strider');
        if (strider) strider.name = 'Aragorn';
        
        const fellowshipMembers = [
            { name: 'Legolas', race: 'Elf', health: 100 },
            { name: 'Gimli', race: 'Dwarf', health: 100 },
            { name: 'Boromir', race: 'Man', health: 100 },
            { name: 'Gandalf', race: 'Wizard', health: 100 }
        ];

        fellowshipMembers.forEach(member => {
            if (!state.fellowship.some(m => m.name === member.name)) {
                state.fellowship.push(member);
            }
        });
        
        state.flags.councilOfElrondComplete = true;
        state.completedTownActions.add('rivendell_council');
    },
    'amonhen': (state) => {
        const boromir = state.fellowship.find(m => m.name === 'Boromir');
        if (boromir) boromir.health = 0;
        state.fellowship = state.fellowship.filter(m => ['Frodo', 'Sam'].includes(m.name));
    },
    'moria': (state) => {
        const gandalf = state.fellowship.find(m => m.name === 'Gandalf');
        if (gandalf) gandalf.health = 0;
        state.morale -= 40; // Huge morale hit
    },
};

function setupNewGame(profession, startKey = 'shire', debugOptions = {}) {
    // 1. Base State Initialization
    gameState = {
        totalHours: 11,
        distanceTraveled: 0,
        food: professions[profession].food,
        supplies: professions[profession].supplies,
        gold: professions[profession].gold,
        morale: 100,
        isGameOver: false,
        mode: 'paused',
        autocampEnabled: false,
        targetDistance: 1000,
        fellowship: [
            { name: 'Frodo', race: 'Hobbit', health: 100 },
            { name: 'Sam', race: 'Hobbit', health: 100 },
            { name: 'Merry', race: 'Hobbit', health: 100 },
            { name: 'Pippin', race: 'Hobbit', health: 100 },
        ],
        currentLocationKey: 'shire',
        pathTaken: ['shire'],
        discoveredStops: new Set(['shire']),
        completedTownActions: new Set(),
        inventory: { athelas: 0, lembas: 0 },
        buffs: {},
        flags: { 
            gollumFollowing: false, 
            councilOfElrondComplete: false,
            isQuickTravel: debugOptions.isQuickTravel || false,
            isStoryOnly: debugOptions.isStoryOnly || false,
        },
    };

    // 2. Simulate journey up to the startKey
    const canonicalPath = ['shire', 'bree', 'weathertop', 'trollshaws', 'rivendell', 'amonhen', 'emynmuil'];
    const startIndex = canonicalPath.indexOf(startKey);

    if (startIndex > 0) {
        const path_to_start = canonicalPath.slice(0, startIndex);
        path_to_start.forEach(locationKey => {
            if (storyTriggers[locationKey]) {
                storyTriggers[locationKey](gameState);
            }
            if (!gameState.pathTaken.includes(locationKey)) {
                gameState.pathTaken.push(locationKey);
            }
            gameState.discoveredStops.add(locationKey);
        });
    }
    
    // 3. Set the final location and distance
    const startData = journeyData[startKey];
    gameState.currentLocationKey = startKey;
    gameState.distanceTraveled = startData.distance;
}

function advanceTime(hours) {
    if (gameState.isGameOver) return;
    const hasSustainingWater = gameState.buffs.sustainingWater > gameState.totalHours;
    const livingMembers = gameState.fellowship.filter(m => m.health > 0).length;
    if (livingMembers > 0 && !hasSustainingWater) {
        gameState.food = Math.max(0, gameState.food - (hours * HOURLY_FOOD_CONSUMPTION * livingMembers / 4));
    }
    gameState.totalHours += hours;
    if (gameState.buffs.sustainingWater && gameState.buffs.sustainingWater <= gameState.totalHours) {
        delete gameState.buffs.sustainingWater;
    }
    updateUI();
    checkGameOver();
}

function gameLoop() {
    if (gameState.isGameOver || gameState.mode !== 'traveling') {
        stopGameLoop();
        return;
    };
    
    const timeOfDay = gameState.totalHours % 24;
    if (timeOfDay >= 23) {
        stopGameLoop();
        showCampView(true);
        return;
    }
    
    const travelMultiplier = gameState.flags.isQuickTravel ? 12 : 1;
    gameState.distanceTraveled += HOURLY_DISTANCE_TRAVEL * travelMultiplier;
    gameState.fellowship.forEach(m => { if (m.health > 0) m.health -= (DAILY_HEALTH_LOSS / 12); });
    
    const currentLocData = journeyData[gameState.currentLocationKey];
    const nextLocKey = currentLocData.next;
    if (nextLocKey && gameState.distanceTraveled >= journeyData[nextLocKey].distance) {
        stopGameLoop();
        gameState.currentLocationKey = nextLocKey;
        gameState.pathTaken.push(nextLocKey);
        gameState.discoveredStops.add(nextLocKey);
        
        const landmarkData = journeyData[nextLocKey];
        if (landmarkData.type === 'town') {
            showTownView(nextLocKey);
        } else if (encounters[nextLocKey]) {
            displayEvent(encounters[nextLocKey]);
        } else {
            showLandmarkView(landmarkData);
        }
        return;
    }
    
    const progress = gameState.distanceTraveled / gameState.targetDistance;
    let encountersPerDay;
    if (progress < 0.5) {
        encountersPerDay = 1 + (progress / 0.5) * 2; // Ramps from 1 to 3
    } else {
        encountersPerDay = 3 - ((progress - 0.5) / 0.5); // Ramps from 3 down to 2
    }
    const hourlyEncounterChance = encountersPerDay / 12;
    
    if (!gameState.flags.isStoryOnly && Math.random() < hourlyEncounterChance) {
        const validEncounters = Object.values(encounters).filter(e => e.trigger === 'travel' && e.weight > 0 && (!e.condition || e.condition()));
        if (validEncounters.length > 0) {
            const totalWeight = validEncounters.reduce((sum, e) => sum + e.weight, 0);
            let randomWeight = Math.random() * totalWeight;
            for (const event of validEncounters) {
                randomWeight -= event.weight;
                if (randomWeight <= 0) {
                    stopGameLoop();
                    displayEvent(event);
                    return;
                }
            }
        }
    }
    advanceTime(1);
}

function checkGameOver() {
    if (gameState.isGameOver) return;
    const frodo = gameState.fellowship.find(m => m.name === 'Frodo');
    const livingMembers = gameState.fellowship.filter(m => m.health > 0).length;

    let reason = "";
    if (frodo && frodo.health <= 0) reason = "the Ringbearer has fallen.";
    else if (livingMembers === 0) reason = "the entire Fellowship has been lost.";
    else if (gameState.food <= 0) reason = "you have run out of food.";
    else if (gameState.morale <= 0) reason = "the fellowship's morale has broken.";

    if (reason) {
        gameState.isGameOver = true;
        stopGameLoop();
        showEncounterView("Journey Ends!", `<p>The Fellowship's journey has ended because ${reason}. The Ring is lost to the enemy. <strong class='text-red-500'>Failure!</strong></p>`, [{ text: "Start Anew", action: initializeStartScreen }]);
    } else if (gameState.currentLocationKey === 'mountdoom') {
        gameState.isGameOver = true;
        stopGameLoop();
        showEncounterView("Victory!", `<p>The One Ring has been cast into the fires of Mount Doom! Middle-earth is saved! <strong class='text-green-500'>Victory!</strong></p>`, [{ text: "Start Anew", action: initializeStartScreen }]);
    }
}

// --- UI & VIEW MANAGEMENT ---

function updateUI() {
    if (!gameState || Object.keys(gameState).length === 0) return;
    const day = Math.floor((gameState.totalHours - 11 + 24) / 24);
    
    partyStatusDisplay.innerHTML = `
        <div class="flex items-center">${ICONS.day} Day ${day}</div>
        <div class="flex items-center">${ICONS.location} ${journeyData[gameState.currentLocationKey].name}</div>
        <div class="flex items-center">${ICONS.distance} ${Math.floor(gameState.distanceTraveled)} mi</div>
        <div class="flex items-center">${ICONS.food} Food: ${Math.floor(gameState.food)}</div>
        <div class="flex items-center">${ICONS.supplies} Supplies: ${Math.floor(gameState.supplies)}</div>
        <div class="flex items-center">${ICONS.morale} Morale: ${Math.floor(gameState.morale)}</div>
        <div class="flex items-center">${ICONS.gold} Gold: ${gameState.gold}</div>
        <div class="flex items-center col-span-full sm:col-span-1 lg:col-span-2">${ICONS.day} ${getTimeOfDayString(gameState.totalHours)}</div>
    `;

    fellowshipDisplay.innerHTML = gameState.fellowship.map(m => {
        const healthInfo = getHealthStatus(m.health);
        return `
            <div class="flex justify-between items-center text-sm">
                <span>${m.name} <span class="text-xs text-stone-400">(${m.race})</span></span>
                <span class="font-semibold ${healthInfo.colorClass}">${healthInfo.text}</span>
            </div>`;
    }).join('');
}

function showTravelView() {
    const currentLoc = journeyData[gameState.currentLocationKey];
    const nextLoc = journeyData[currentLoc.next];
    const progress = nextLoc ? (gameState.distanceTraveled - currentLoc.distance) / (nextLoc.distance - currentLoc.distance) * 100 : 100;

    mainView.innerHTML = `
        <div class="text-center mb-6">
            <h3 class="font-title text-3xl text-sky-300 mb-2">${currentLoc.legName || 'The Journey Continues'}</h3>
            <p class="text-stone-400">From ${currentLoc.name} to ${nextLoc ? nextLoc.name : 'an unknown destination'}</p>
        </div>
        <div class="w-full bg-zinc-700 rounded-full h-2.5 mb-4">
            <div class="bg-emerald-500 h-2.5 rounded-full" style="width: ${progress}%"></div>
        </div>
        <div id="travel-animation" class="text-center my-auto text-2xl font-mono text-emerald-400 tracking-widest">
            <!-- Animation will be updated by a separate timer -->
        </div>
        <div class="mt-auto grid grid-cols-1 sm:grid-cols-3 gap-4 pt-6">
            <button id="travel-button" class="game-button bg-emerald-800 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform hover:scale-105">Continue Journey</button>
            <button id="camp-button" class="game-button bg-amber-800 hover:bg-amber-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform hover:scale-105">Make Camp</button>
            <button id="map-button" class="game-button bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform hover:scale-105">View Map</button>
        </div>
    `;
    
    document.getElementById('camp-button').addEventListener('click', () => showCampView(false));
    document.getElementById('map-button').addEventListener('click', () => showMapView(showTravelView));
    
    const travelButton = document.getElementById('travel-button');
    if (gameState.mode === 'traveling') {
        travelButton.textContent = "Stop Traveling";
        travelButton.onclick = () => stopGameLoop();
    } else {
        travelButton.textContent = "Continue Journey";
        travelButton.onclick = () => startGameLoop();
    }
    updateTravelAnimation();
}

function updateTravelAnimation() {
    const animEl = document.getElementById('travel-animation');
    if (!animEl) return;
    const hour = Math.floor(gameState.totalHours % 24);
    const icon = (hour >= 5 && hour < 18) ? '☀️' : '🌙';
    const path = Array(12).fill('⋅');
    if (gameState.mode === 'traveling') {
        animationFrame = (animationFrame + 1) % 12;
        path[animationFrame] = '🚶‍♂️‍➡️';
    } else {
        path[0] = '🏕️';
    }
    animEl.innerHTML = `<div class="text-4xl mb-2">${icon}</div><div>${path.join('')}</div>`;
}

function showEncounterView(title, description, choices) {
    gameState.mode = 'event';
    mainView.innerHTML = `
        <div class="text-center flex-grow flex flex-col justify-center">
            <h3 class="font-title text-3xl text-amber-300 mb-4">${title}</h3>
            <p class="text-stone-300 max-w-xl mx-auto mb-8 text-lg leading-relaxed">${description}</p>
        </div>
        <div id="choices-area" class="mt-auto grid grid-cols-1 sm:grid-cols-2 gap-4 pt-6">
            <!-- Choices will be injected here -->
        </div>
    `;
    const choicesArea = document.getElementById('choices-area');
    choices.forEach(choice => {
        const button = document.createElement('button');
        button.textContent = choice.text;
        button.className = "game-button bg-sky-800 hover:bg-sky-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform hover:scale-105";
        button.onclick = choice.action;
        if (choice.condition && !choice.condition()) {
            button.disabled = true;
        }
        choicesArea.appendChild(button);
    });
}

function showCampView(isForcedNight) {
    stopGameLoop();
    let title = isForcedNight ? "The Day's Journey is Over" : "You Make Camp";
    let description = isForcedNight ? "Darkness has fallen. You make camp and rest." : "You decide to pause your journey and set up camp to rest and recover.";
    
    mainView.innerHTML = `
        <div class="text-center mb-6">
            <div class="text-7xl mb-4">🏕️</div>
            <h3 class="font-title text-3xl text-amber-300 mb-2">${title}</h3>
            <p class="text-stone-400">${description}</p>
        </div>
        <div id="camp-results" class="text-center my-4 text-lg text-emerald-300 min-h-[2rem]"></div>
        <div class="mt-auto grid grid-cols-2 sm:grid-cols-3 gap-4 pt-6">
            <button id="break-camp-btn" class="game-button bg-emerald-800 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform hover:scale-105">Continue</button>
            <button id="map-btn" class="game-button bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform hover:scale-105">View Map</button>
            <button id="extended-rest-btn" class="game-button bg-amber-800 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-lg">Extended Rest</button>
            <button id="forage-btn" class="game-button bg-amber-800 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-lg">Forage</button>
            <button id="hunt-btn" class="game-button bg-amber-800 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-lg">Hunt</button>
            <button id="scavenge-btn" class="game-button bg-amber-800 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-lg">Scavenge</button>
        </div>
    `;

    document.getElementById('break-camp-btn').addEventListener('click', startGameLoop);
    document.getElementById('map-btn').addEventListener('click', () => showMapView(() => showCampView(false)));
    document.getElementById('extended-rest-btn').addEventListener('click', campActions.extendedRest);
    document.getElementById('forage-btn').addEventListener('click', campActions.forage);
    document.getElementById('hunt-btn').addEventListener('click', campActions.hunt);
    document.getElementById('scavenge-btn').addEventListener('click', campActions.scavenge);
}

function showTownView(locationKey) {
    stopGameLoop();
    const townData = journeyData[locationKey];
    const actions = townActions[locationKey];

    mainView.innerHTML = `
        <div class="text-center mb-6">
            <h3 class="font-title text-4xl text-amber-300 mb-2">Welcome to ${townData.name}</h3>
            <p class="text-stone-400 max-w-2xl mx-auto">${townData.description}</p>
        </div>
        <div id="town-dialogue" class="text-center my-4 text-lg text-emerald-300 min-h-[2rem]"></div>
        <div id="town-actions-container" class="mt-auto grid grid-cols-2 sm:grid-cols-3 gap-4 pt-6">
            <!-- Town actions go here -->
        </div>
    `;

    const dialogueEl = document.getElementById('town-dialogue');
    const actionsContainer = document.getElementById('town-actions-container');

    actions.forEach(action => {
        const isCompleted = action.oneTime && gameState.completedTownActions.has(action.id);
        const meetsCondition = !action.condition || action.condition();

        if (meetsCondition) {
            const button = document.createElement('button');
            button.textContent = action.text;
            button.className = action.isLeaveAction 
                ? "game-button bg-emerald-800 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg"
                : "game-button bg-sky-800 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg";
            
            if (isCompleted) {
                button.disabled = true;
            } else {
                button.onclick = () => {
                    if (action.oneTime) {
                        gameState.completedTownActions.add(action.id);
                    }
                    action.action(dialogueEl);
                    if (!action.isLeaveAction) {
                        showTownView(locationKey); // Refresh view after action
                    }
                    updateUI();
                };
            }
            actionsContainer.appendChild(button);
        }
    });
}

function showLandmarkView(landmark) {
    stopGameLoop();
    mainView.innerHTML = `
        <div class="text-center my-auto">
             <h3 class="font-title text-4xl text-amber-300 mb-2">Arrived: ${landmark.name}</h3>
             <p class="text-stone-400 text-lg">You have reached a milestone on your journey. You pause for a moment before pressing on.</p>
        </div>
        <div class="mt-auto pt-6">
            <button id="continue-journey-btn" class="w-full game-button bg-emerald-800 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform hover:scale-105">Continue the Journey</button>
        </div>
    `;
    document.getElementById('continue-journey-btn').addEventListener('click', startGameLoop);
}

function showMapView(returnAction) {
    stopGameLoop();
    mainView.innerHTML = `
        <h3 class="font-title text-3xl text-sky-300 mb-4 text-center">Map of Middle-earth</h3>
        <div class="flex-grow bg-zinc-900/50 rounded-lg border border-zinc-700 p-2">
            <svg id="large-map-svg" viewBox="0 0 1000 800"></svg>
        </div>
        <div class="mt-auto pt-6">
            <button id="return-journey-btn" class="w-full game-button bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform hover:scale-105">Return</button>
        </div>
    `;
    document.getElementById('return-journey-btn').addEventListener('click', returnAction || showTravelView);
    drawMap(document.getElementById('large-map-svg'));
}

function displayEvent(event) {
    let choices = event.choices;
    // If choices is a function, call it to get the dynamic choices
    if (typeof choices === 'function') {
        choices = choices();
    }

    const eventChoices = choices.map(choice => ({
        ...choice,
        action: () => {
            const resultText = choice.action();
            showEncounterView(event.name, resultText, [{ text: "Continue", action: () => showTravelView() }]);
            updateUI();
        }
    }));
    showEncounterView(event.name, event.description, eventChoices);
}

// --- GAME LOOP CONTROLLERS ---
function startGameLoop() {
    if (gameState.isGameOver || gameState.mode === 'traveling') return;
    
    const timeOfDay = gameState.totalHours % 24;
    if (timeOfDay >= 23 || timeOfDay < 11) {
        const hoursToWait = (24 - timeOfDay + 11) % 24;
        advanceTime(hoursToWait);
        if(gameState.isGameOver) return;
    }
    
    gameState.mode = 'traveling';
    showTravelView(); 

    clearInterval(gameLoopInterval);
    gameLoopInterval = setInterval(gameLoop, 1000 / HOURS_PER_SECOND);
}

function stopGameLoop() {
    clearInterval(gameLoopInterval);
    if(gameState.mode === 'traveling') {
        gameState.mode = 'paused';
        showTravelView();
    }
}

const campActions = {
    forage: () => {
        advanceTime(6);
        const f = Math.floor(Math.random() * 5) + 8;
        gameState.food += f;
        document.getElementById('camp-results').innerHTML = `<p class='text-emerald-300'>You spend much of the morning foraging and find ${f} food.</p>`;
        updateUI();
    },
    hunt: () => {
        advanceTime(4);
        const roll = Math.random();
        let resultText = '';
        if (roll < 0.25) {
            gameState.fellowship.forEach(m => m.health -= 15);
            resultText = `<p class='text-rose-400'>The hunt goes poorly! The party was injured and found nothing after a few hours.</p>`;
        } else if (roll < 0.75) {
            resultText = `<p class='text-amber-400'>You hunted for several hours but found nothing.</p>`;
        } else {
            const f = Math.floor(Math.random() * 20) + 20;
            gameState.food += f;
            resultText = `<p class='text-emerald-300'>A successful hunt! You brought back ${f} food after a few hours.</p>`;
        }
        document.getElementById('camp-results').innerHTML = resultText;
        updateUI();
    },
    scavenge: () => {
        advanceTime(8);
        const roll = Math.random();
        let resultText = '';
        if (roll < 0.2) {
            stopGameLoop();
            displayEvent(encounters['orc-patrol']);
            return; // Exit here to prevent updating a non-existent element
        } else if (roll < 0.6) {
            const s = Math.floor(Math.random() * 10) + 5;
            gameState.supplies += s;
            resultText = `<p class='text-emerald-300'>After a long day of scavenging, you found ${s} useful supplies!</p>`;
        } else {
            resultText = `<p class='text-amber-400'>You scavenged for most of the day but found nothing of note.</p>`;
        }
        const campResultsEl = document.getElementById('camp-results');
        if (campResultsEl) {
            campResultsEl.innerHTML = resultText;
        }
        updateUI();
    },
    extendedRest: () => {
        advanceTime(24);
        gameState.fellowship.forEach(m => { if (m.health > 0) m.health = Math.min(100, m.health + (DAILY_HEALTH_LOSS * 5)); });
        gameState.morale = Math.min(100, gameState.morale + 15);
        document.getElementById('camp-results').innerHTML = `<p class='text-emerald-300'>You rest for a full day, recovering your strength.</p>`;
        updateUI();
    }
};

// --- MAP DRAWING ---
function drawMap(svgElement) {
    svgElement.innerHTML = ''; 
    
    // Landmass & Features
    const features = {
        coast: 'M130,340 C100,450 150,550 280,600 L350,700 L500,750 L650,720 L750,680 L800,600 L850,500 L820,400 C800,300 700,250 600,250 C500,250 400,200 300,180 C200,150 150,250 130,340 Z',
        misty_mountains: 'M400,100 C420,200 440,300 450,400 C460,500 480,600 500,700',
        mordor_mountains_n: 'M680,580 L750,580 L820,590',
        mordor_mountains_w: 'M680,580 L670,650 L680,720',
        mirkwood: 'M500,200 C520,250 530,350 500,450',
        fangorn: 'M550,580 C530,620 550,660 580,680'
    };
    
    for (const key in features) {
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', features[key]);
        path.setAttribute('class', 'map-feature');
        if (key === 'coast') {
            path.classList.add('fill-stone-800/50');
        }
        svgElement.appendChild(path);
    }

    const takenRouteGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    for (let i = 0; i < gameState.pathTaken.length - 1; i++) {
        const startPoint = journeyData[gameState.pathTaken[i]];
        const endPoint = journeyData[gameState.pathTaken[i+1]];
        if (!startPoint || !endPoint) continue;
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', startPoint.x); line.setAttribute('y1', startPoint.y);
        line.setAttribute('x2', endPoint.x); line.setAttribute('y2', endPoint.y);
        line.setAttribute('class', 'stroke-emerald-400/50');
        line.setAttribute('stroke-width', '3');
        takenRouteGroup.appendChild(line);
    }
    svgElement.appendChild(takenRouteGroup);

    const landmarksGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    for (const key in journeyData) {
        const landmark = journeyData[key];
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', landmark.x); circle.setAttribute('cy', landmark.y);
        
        if (gameState.discoveredStops.has(key)) {
            circle.setAttribute('r', '8');
            circle.setAttribute('class', 'fill-amber-500 stroke-zinc-900 stroke-2');
            landmarksGroup.appendChild(circle);

            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', landmark.x); text.setAttribute('y', landmark.y - 15);
            text.textContent = landmark.name;
            text.setAttribute('class', 'map-landmark-label');
            landmarksGroup.appendChild(text);
        } else {
            circle.setAttribute('r', '3');
            circle.setAttribute('class', 'fill-stone-500');
            landmarksGroup.appendChild(circle);
        }
    }
    svgElement.appendChild(landmarksGroup);

    const currentLoc = journeyData[gameState.currentLocationKey];
    const nextLocKey = currentLoc.next;
    let playerX = currentLoc.x;
    let playerY = currentLoc.y;
    
    if (nextLocKey && journeyData[nextLocKey]) {
        const nextLoc = journeyData[nextLocKey];
        const segmentDist = nextLoc.distance - currentLoc.distance;
        const progressOnSegment = (gameState.distanceTraveled - currentLoc.distance) / segmentDist;
        if (progressOnSegment > 0 && progressOnSegment < 1) {
            playerX = currentLoc.x + (nextLoc.x - currentLoc.x) * progressOnSegment;
            playerY = currentLoc.y + (nextLoc.y - currentLoc.y) * progressOnSegment;
        } else if (progressOnSegment >= 1) {
            playerX = nextLoc.x;
            playerY = nextLoc.y;
        }
    }

    const playerMarker = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    playerMarker.setAttribute('cx', playerX);
    playerMarker.setAttribute('cy', playerY);
    playerMarker.setAttribute('r', '6');
    playerMarker.setAttribute('class', 'fill-rose-600 stroke-white');
    svgElement.appendChild(playerMarker);
}

// --- INITIALIZATION ---
function initializeGame(profession, startKey, debugOptions) {
    startScreen.style.display = 'none';
    gameContainer.style.display = 'block';
    
    setupNewGame(profession, startKey, debugOptions);
    
    const startingLandmark = journeyData[startKey];
    if (startingLandmark.type === 'town') {
        showTownView(startKey);
    } else if (encounters[startKey]) {
        displayEvent(encounters[startKey]);
    } else {
        showTravelView();
    }
    updateUI();
    
    setInterval(updateTravelAnimation, 500);
}

function initializeStartScreen() {
    gameContainer.style.display = 'none';
    startScreen.style.display = 'flex';
    const beginButton = document.getElementById('begin-journey-button');
    const professionCards = document.querySelectorAll('.profession-card');
    let selectedProfession = null;
    
    const debugSelect = document.getElementById('debug-start-select');
    debugSelect.innerHTML = ''; // Clear previous options
    for (const key in journeyData) {
        if (Object.prototype.hasOwnProperty.call(journeyData, key)) {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = journeyData[key].name;
            debugSelect.appendChild(option);
        }
    }

    professionCards.forEach(card => {
        card.addEventListener('click', () => {
            professionCards.forEach(c => c.classList.remove('border-amber-400/50'));
            card.classList.add('border-amber-400/50');
            selectedProfession = card.dataset.profession;
            beginButton.disabled = false;
        });
    });

    beginButton.onclick = () => {
        if(selectedProfession) {
            const debugOptions = {
                isQuickTravel: document.getElementById('debug-quick-travel').checked,
                isStoryOnly: document.getElementById('debug-story-only').checked,
            };
            initializeGame(selectedProfession, debugSelect.value, debugOptions);
        }
    };
}

// Expose functions to global scope for onclick handlers
window.game = {
    startGameLoop,
    stopGameLoop,
    showCampView,
    showMapView,
    showTravelView,
    campActions
};

window.onload = () => {
    initializeStartScreen();
};

</script>
</body>
</html>
